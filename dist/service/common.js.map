{"version":3,"sources":["../src/service/common.ts"],"names":[],"mappings":"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","file":"common.js","sourcesContent":["import {UserDetail, GroupInfo, RoomInfo, UserOutline, Passenger, APIOptions, Callback} from \"../model/models\";\nimport axios = require('axios');\nimport ResponseInterceptor = Axios.ResponseInterceptor;\n\ninterface SearchBuilder {\n    forUsers(callback: Callback<UserOutline[]>);\n    forGroups(callback: Callback<GroupInfo[]>);\n    forRooms(callback: Callback<RoomInfo[]>);\n}\n\ninterface LoadBuilder {\n    forUser(callback: Callback<UserDetail>);\n    forGroup(callback: Callback<GroupInfo>);\n    forRoom(callback: Callback<RoomInfo>);\n    forPassenger(callback: Callback<Passenger>);\n}\n\ninterface GetAttributesBuilder {\n    forUser(callback?: Callback<any>);\n    forGroup(callback?: Callback<any>);\n    forRoom(callback?: Callback<any>);\n}\n\ninterface CommonService {\n    /**\n     * 获取当前基础设定\n     */\n    options(): APIOptions;\n    /**\n     * 搜索对象\n     * @param query 查询条件\n     * @param skip 跳过记录数\n     * @param limit 返回记录条数\n     * @param sort 排序\n     */\n    search(query?: {[key: string]: any}, skip?: number, limit?: number, sort?: string[]): SearchBuilder;\n    /**\n     * 载入对象\n     * @param id 对象ID\n     */\n    load(id: string): LoadBuilder;\n\n    /**\n     * 获取属性\n     * @param id\n     */\n    getAttributes(id: string, attributeName?: string): GetAttributesBuilder;\n\n    /**\n     * 上传附件\n     * @param attachment\n     */\n    attachment(attachment: File|Blob): AttachmentBuilder;\n}\n\ninterface AttachmentBuilder {\n    ok(callback?: Callback<string[]>);\n}\n\ninterface LoadOptions {\n    id: string;\n}\n\ninterface SearchOptions {\n    query?: {[key: string]: any};\n    skip?: number;\n    limit?: number;\n    sort?: string[];\n}\n\nclass AttachmentBuilderImpl implements AttachmentBuilder {\n\n    private apiOptions: APIOptions;\n    private attachment: File|Blob;\n\n    constructor(apiOptions: APIOptions, attachment: File|Blob) {\n        this.apiOptions = apiOptions;\n        this.attachment = attachment;\n    }\n\n    ok(callback?: Callback<string[]>): void {\n        let data: FormData = new FormData();\n        data.append('attachment', this.attachment);\n        let url = `${this.apiOptions.server}/attachment`;\n        let header: {[key: string]: string} = {};\n        for (let k in this.apiOptions.headers) {\n            if (k.toLowerCase() !== 'content-type') {\n                header[k] = this.apiOptions.headers[k];\n            }\n        }\n\n        axios.post(url, data, {headers: header})\n            .then(response => {\n                return response.data as string[];\n            })\n            .then(result => {\n                if (callback) {\n                    callback(null, result);\n                }\n            })\n            .catch(e => {\n                if (callback) {\n                    callback(e);\n                }\n            });\n    }\n}\n\nclass GetAttributesBuilderImpl implements GetAttributesBuilder {\n\n    private id: string;\n    private attr: string;\n    private common: CommonServiceImpl;\n\n    constructor(common: CommonServiceImpl, id: string, attr?: string) {\n        this.common = common;\n        this.id = id;\n        this.attr = attr;\n    }\n\n    private forAttr(path: string, callback: Callback<any>) {\n        let url = `${this.common.options().server}${path}/attributes`;\n        if (this.attr) {\n            url += `/${this.attr}`;\n        }\n\n        axios.get(url, {headers: this.common.options().headers})\n            .then(response => {\n                return response.data as string;\n            })\n            .then(result => {\n                if (callback) {\n                    callback(null, result);\n                }\n            })\n            .catch(e => {\n                if (callback) {\n                    callback(e);\n                }\n            });\n    }\n\n    forUser(callback?: Callback<any>) {\n        if (!callback) {\n            return;\n        }\n        this.forAttr(`/ctx/${this.id}`, callback);\n    }\n\n    forGroup(callback?: Callback<any>) {\n        if (!callback) {\n            return;\n        }\n        this.forAttr(`/groups/${this.id}`, callback);\n    }\n\n    forRoom(callback?: Callback<any>) {\n        if (!callback) {\n            return;\n        }\n        this.forAttr(`/rooms/${this.id}`, callback);\n    }\n}\n\nclass Builder<T> {\n    apiOptions: APIOptions;\n    extOptions: T;\n\n    constructor(apiOptions: APIOptions, extOptions?: T) {\n        this.apiOptions = apiOptions;\n        this.extOptions = extOptions;\n    }\n}\n\nclass LoadBuilderImpl extends Builder<LoadOptions> implements LoadBuilder {\n\n    private forSomething<T>(path: string, callback: Callback<T>) {\n        let url = `${this.apiOptions.server}${path}/${this.extOptions.id}`;\n\n        axios.post(url, null, {headers: this.apiOptions.headers})\n            .then(response => {\n                return response.data as T;\n            })\n            .then(result => {\n                if (callback) {\n                    callback(null, result);\n                }\n            })\n            .catch(e => {\n                if (callback) {\n                    callback(e);\n                }\n            });\n    }\n\n    forUser(callback: Callback<UserDetail>) {\n        this.forSomething('/ctx', callback);\n    }\n\n    forGroup(callback: Callback<GroupInfo>) {\n        this.forSomething('/groups', callback);\n    }\n\n    forRoom(callback: Callback<RoomInfo>) {\n        this.forSomething('/rooms', callback);\n    }\n\n    forPassenger(callback: Callback<Passenger>) {\n        this.forSomething('/passengers', callback);\n    }\n}\n\nclass SearchBuilderImpl extends Builder<SearchOptions> implements SearchBuilder {\n\n    private getUrl(path: string): string {\n        let q: string[] = [];\n        for (let k in this.extOptions.query) {\n            let v = this.extOptions.query[k];\n            q.push(`${k}=${v}`);\n        }\n        q.push(`_skip=${this.extOptions.skip || 0}`);\n        q.push(`_limit=${this.extOptions.limit || 20}`);\n        return `${this.apiOptions.server}${path}?${q.join('&')}`;\n    }\n\n    private forSomething<T>(path: string, callback: Callback<T>) {\n        let url = this.getUrl(path);\n\n\n        axios.get(url, {headers: this.apiOptions.headers})\n            .then(response => {\n                return response.data as T;\n            })\n            .then(result => {\n                if (callback) {\n                    callback(null, result);\n                }\n            })\n            .catch(e => {\n                if (callback) {\n                    callback(e);\n                }\n            });\n    }\n\n    forUsers(callback?: Callback<UserOutline[]>) {\n        this.forSomething('/ctx', callback);\n    }\n\n    forGroups(callback?: Callback<GroupInfo[]>) {\n        this.forSomething('/groups', callback);\n    }\n\n    forRooms(callback?: Callback<RoomInfo[]>) {\n        this.forSomething('/rooms', callback);\n    }\n}\n\nclass CommonServiceImpl implements CommonService {\n\n\n    private _options: APIOptions;\n\n    constructor(apiOptions: APIOptions) {\n        this._options = apiOptions;\n    }\n\n    options(): APIOptions {\n        return this._options;\n    }\n\n    search(query?: {}, skip?: number, limit?: number, sort?: string[]): SearchBuilder {\n        let searchOptions: SearchOptions = {\n            limit: limit,\n            skip: skip,\n            query: query,\n            sort: sort\n        };\n        return new SearchBuilderImpl(this._options, searchOptions);\n    }\n\n    load(id: string): LoadBuilder {\n        let opts = {\n            id: id\n        };\n        return new LoadBuilderImpl(this._options, opts);\n    }\n\n    getAttributes(id: string, attributeName?: string): GetAttributesBuilder {\n        return new GetAttributesBuilderImpl(this, id, attributeName);\n    }\n\n    attachment(attachment: File): AttachmentBuilder {\n        return new AttachmentBuilderImpl(this._options, attachment);\n    }\n}\n\nexport {\n    CommonService,\n    CommonServiceImpl\n}"]}