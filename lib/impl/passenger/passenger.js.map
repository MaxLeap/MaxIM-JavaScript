{"version":3,"sources":["../src/impl/passenger/passenger.ts"],"names":[],"mappings":"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","file":"passenger.js","sourcesContent":["import * as io from \"socket.io-client\";\nimport {PassengerBuilder, PassengerContext, PassengerSession,} from \"../../api/passenger\";\nimport {md5} from \"../../helper/md5\";\nimport {convert2basic, ParrotError} from \"../../helper/utils\";\nimport {BasicMessageFrom, MessageFrom, Receiver} from \"../../model/messages\";\nimport {APIOptions, Attributes, Callback2, Handler1, Handler2, LoginResult} from \"../../model/models\";\nimport {PassengerContextImpl} from \"./context\";\nimport {PassengerSessionImpl} from \"./session\";\n\nclass PassengerBuilderImpl implements PassengerBuilder {\n\n  private id: string;\n  private options: APIOptions;\n  private attributes: Attributes = [];\n  private fromUser: Array<Handler2<string, BasicMessageFrom>> = [];\n  private fromSystem: Array<Handler1<BasicMessageFrom>> = [];\n  private fromStrangerOnline: Array<Handler1<string>> = [];\n  private fromStrangerOffline: Array<Handler1<string>> = [];\n  private acks: Array<Handler2<number, number>> = [];\n\n  constructor(options: APIOptions, id?: string) {\n    this.options = options;\n    this.id = id;\n  }\n\n  public attribute(name: string, value: any): PassengerBuilder {\n    this.attributes[name] = value;\n    return this;\n  }\n\n  public onUserMessage(callback: Handler2<string, BasicMessageFrom>): PassengerBuilder {\n    this.fromUser.push(callback);\n    return this;\n  }\n\n  public onSystemMessage(callback: Handler1<BasicMessageFrom>): PassengerBuilder {\n    this.fromSystem.push(callback);\n    return this;\n  }\n\n  public onStrangerOnline(callback: Handler1<string>): PassengerBuilder {\n    this.fromStrangerOnline.push(callback);\n    return this;\n  }\n\n  public onStrangerOffline(callback: Handler1<string>): PassengerBuilder {\n    this.fromStrangerOffline.push(callback);\n    return this;\n  }\n\n  public onAck(callback: Handler2<number, number>): PassengerBuilder {\n    this.acks.push(callback);\n    return this;\n  }\n\n  public ok(callback: Callback2<PassengerSession, PassengerContext>) {\n    const url = `${this.options.server}/chat`;\n\n    const foo = new Date().getTime();\n    const bar = md5(`${foo}${this.options.sign}`) + \",\" + foo;\n    const qux: any = {};\n    const authdata = {\n      app: this.options.app,\n      sign: bar,\n      passenger: qux,\n    };\n\n    for (const k in this.attributes) {\n      if (k === \"id\") {\n        continue;\n      }\n      qux[k] = this.attributes[k];\n    }\n\n    if (this.id) {\n      qux.id = this.id;\n    }\n\n    const socket = io.connect(url, {\n      query: `auth=${JSON.stringify(authdata)}`,\n      transports: [\"websocket\"],\n    });\n    socket.once(\"login\", (result) => {\n      const foo = result as LoginResult;\n      if (foo.success) {\n        const session = new PassengerSessionImpl(socket, foo.id);\n        const ctx = new PassengerContextImpl(this.options, foo.id);\n        callback(null, session, ctx);\n      } else {\n        const err = new ParrotError({errorCode: foo.error, errorMessage: \"\"});\n        callback(err);\n      }\n    });\n\n    socket.on(\"message\", (income) => {\n      const msg = income as MessageFrom;\n      const basicmsg = convert2basic(msg);\n\n      switch (msg.from.type) {\n        case Receiver.ACTOR:\n          for (const handler of this.fromUser) {\n            handler(msg.from.id, basicmsg);\n          }\n          break;\n        default:\n          break;\n      }\n    });\n\n    socket.on(\"online_x\", (onlineid) => {\n      for (const handler of this.fromStrangerOnline) {\n        handler(onlineid as string);\n      }\n    });\n\n    socket.on(\"offline_x\", (offlineid) => {\n      for (const handler of this.fromStrangerOffline) {\n        handler(offlineid as string);\n      }\n    });\n\n    socket.on(\"sys\", (income) => {\n      const msg = income as BasicMessageFrom;\n      for (const handler of this.fromSystem) {\n        handler(msg);\n      }\n    });\n\n    socket.on(\"ack\", (income) => {\n      const msg = income as { ack: number, ts: number };\n      for (const it of this.acks) {\n        it(msg.ack, msg.ts);\n      }\n    });\n\n  }\n}\n\nexport {\n  PassengerBuilderImpl,\n};\n"]}