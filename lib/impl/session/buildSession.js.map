{"version":3,"sources":["../src/impl/session/buildSession.ts"],"names":[],"mappings":"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","file":"buildSession.js","sourcesContent":["import * as io from \"socket.io-client\";\nimport {Context} from \"../../api/context\";\nimport {Session, SessionBuilder} from \"../../api/session\";\nimport {convert2basic} from \"../../helper/utils\";\nimport {BasicMessageFrom, MessageFrom, Receiver, SystemMessageFrom, YourselfMessageFrom} from \"../../model/messages\";\nimport {APIOptions, Callback2, Handler1, Handler2, Handler3, LoginResult} from \"../../model/models\";\nimport {ContextImpl} from \"../context/context\";\nimport {SessionImpl} from \"./session\";\n\nclass SessionBuilderImpl implements SessionBuilder {\n\n  private friends: Array<Handler2<string, BasicMessageFrom>>;\n  private groups: Array<Handler3<string, string, BasicMessageFrom>>;\n  private rooms: Array<Handler3<string, string, BasicMessageFrom>>;\n  private passengers: Array<Handler2<string, BasicMessageFrom>>;\n  private strangers: Array<Handler2<string, BasicMessageFrom>>;\n  private friendonlines: Array<Handler1<string>>;\n  private friendofflines: Array<Handler1<string>>;\n  private strangeronlineds: Array<Handler1<string>>;\n  private strangerofflines: Array<Handler1<string>>;\n  private systems: Array<Handler1<SystemMessageFrom>>;\n  private yourselfs: Array<Handler1<YourselfMessageFrom>>;\n  private acks: Array<Handler2<number, number>>;\n\n  private apiOptions: APIOptions;\n  private authdata: any;\n\n  constructor(apiOptions: APIOptions, authdata: {}) {\n    this.apiOptions = apiOptions;\n    this.authdata = authdata;\n\n    this.friends = [];\n    this.groups = [];\n    this.rooms = [];\n    this.passengers = [];\n    this.strangers = [];\n\n    this.friendonlines = [];\n    this.friendofflines = [];\n    this.strangeronlineds = [];\n    this.strangerofflines = [];\n    this.systems = [];\n    this.yourselfs = [];\n    this.acks = [];\n  }\n\n  public setNotifyAll(enable: boolean): SessionBuilder {\n    this.authdata.notifyAll = enable;\n    return this;\n  }\n\n  public setInstallation(installation: string): SessionBuilder {\n    this.authdata.install = installation;\n    return this;\n  }\n\n  public onFriendMessage(handler: Handler2<string, BasicMessageFrom>): SessionBuilder {\n    this.friends.push(handler);\n    return this;\n  }\n\n  public onGroupMessage(handler: Handler3<string, string, MessageFrom>): SessionBuilder {\n    this.groups.push(handler);\n    return this;\n  }\n\n  public onRoomMessage(handler: Handler3<string, string, MessageFrom>): SessionBuilder {\n    this.rooms.push(handler);\n    return this;\n  }\n\n  public onPassengerMessage(handler: Handler2<string, MessageFrom>): SessionBuilder {\n    this.passengers.push(handler);\n    return this;\n  }\n\n  public onStrangerMessage(handler: Handler2<string, MessageFrom>): SessionBuilder {\n    this.strangers.push(handler);\n    return this;\n  }\n\n  public onFriendOnline(handler: Handler1<string>): SessionBuilder {\n    this.friendonlines.push(handler);\n    return this;\n  }\n\n  public onFriendOffline(handler: Handler1<string>): SessionBuilder {\n    this.friendofflines.push(handler);\n    return this;\n  }\n\n  public onStrangerOnline(handler: Handler1<string>): SessionBuilder {\n    this.strangeronlineds.push(handler);\n    return this;\n  }\n\n  public onStrangerOffline(handler: Handler1<string>): SessionBuilder {\n    this.strangerofflines.push(handler);\n    return this;\n  }\n\n  public onSystemMessage(handler: Handler1<SystemMessageFrom>): SessionBuilder {\n    this.systems.push(handler);\n    return this;\n  }\n\n  public onAck(handler: Handler2<number, number>): SessionBuilder {\n    this.acks.push(handler);\n    return this;\n  }\n\n  public onYourself(handler: Handler1<YourselfMessageFrom>): SessionBuilder {\n    this.yourselfs.push(handler);\n    return this;\n  }\n\n  public ok(callback: Callback2<Session, Context>) {\n    const url = `${this.apiOptions.server}/chat`;\n    const socket = io.connect(url, {\n      query: `auth=${JSON.stringify(this.authdata)}`,\n      transports: [\"websocket\"],\n    });\n    socket.once(\"login\", (result) => {\n      const foo = result as LoginResult;\n      if (foo.success) {\n        const session = new SessionImpl(socket, foo.id);\n        const ctx = new ContextImpl(this.apiOptions, result.id);\n        callback(null, session, ctx);\n      } else {\n        callback(new Error(`error: ${foo.error}`), null, null);\n      }\n    });\n\n    socket.on(\"message\", (income) => {\n      const msg = income as MessageFrom;\n      const basicmsg = convert2basic(msg);\n      switch (msg.from.type) {\n        case Receiver.ACTOR:\n          for (const it of this.friends) {\n            it(msg.from.id, basicmsg);\n          }\n          break;\n        case Receiver.GROUP:\n          for (const it of this.groups) {\n            it(msg.from.gid, msg.from.id, basicmsg);\n          }\n          break;\n        case Receiver.ROOM:\n          for (const it of this.rooms) {\n            it(msg.from.gid, msg.from.id, basicmsg);\n          }\n          break;\n        case Receiver.PASSENGER:\n          for (const it of this.passengers) {\n            it(msg.from.id, basicmsg);\n          }\n          break;\n        case Receiver.STRANGER:\n          for (const it of this.strangers) {\n            it(msg.from.id, basicmsg);\n          }\n          break;\n        default:\n          break;\n      }\n    });\n\n    socket.on(\"online\", (onlineid) => {\n      for (const it of this.friendonlines) {\n        it(onlineid as string);\n      }\n    });\n\n    socket.on(\"offline\", (offlineid) => {\n      for (const it of this.friendofflines) {\n        it(offlineid as string);\n      }\n    });\n\n    socket.on(\"online_x\", (onlineid) => {\n      for (const it of this.strangeronlineds) {\n        it(onlineid as string);\n      }\n    });\n\n    socket.on(\"offline_x\", (offlineid) => {\n      for (const it of this.strangerofflines) {\n        it(offlineid as string);\n      }\n    });\n\n    socket.on(\"sys\", (income) => {\n      const msg = income as BasicMessageFrom;\n      for (const it of this.systems) {\n        it(msg);\n      }\n    });\n\n    socket.on(\"yourself\", (income) => {\n      const msg = income as YourselfMessageFrom;\n      for (const it of this.yourselfs) {\n        it(msg);\n      }\n    });\n\n    socket.on(\"ack\", (income) => {\n      const msg = income as { ack: number, ts: number };\n      for (const it of this.acks) {\n        it(msg.ack, msg.ts);\n      }\n    });\n  }\n}\n\nexport {\n  SessionBuilderImpl,\n};\n"]}